<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title></title>
	<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
</head>
<script src="js/jquery-1.9.1.js"></script>

<body>
<div id="app">
	<el-table :data="tableData" style="width: 100%" @selection-change="handleSelectionChange">
		<el-table-column type="selection">
		</el-table-column>
		<el-table-column prop="type" label="字典类型" width="180">
		</el-table-column>
		<el-table-column prop="describe" label="用途描述" width="180">
		</el-table-column>
		<el-table-column prop="code" label="编码">
		</el-table-column>
		<el-table-column prop="cvalue" label="编码值">
		</el-table-column>
		<el-table-column label="操作">
			<template slot-scope="scope">
				<el-button type="primary" icon="el-icon-setting" @click="handleEdit(scope.$index,true)"></el-button>
			</template>
		</el-table-column>
	</el-table>
	<el-button type="primary" icon="el-icon-edit" @click="handleEdit(0,false)"></el-button>
	<el-button type="primary" icon="el-icon-delete" @click="handleDel()"></el-button>
	<div class="update">
		<el-dialog title="数据字典" :visible.sync="dialogVisible">
			<el-form ref="form" :model="form" label-width="80px">
				<el-form-item label="字典类型" prop="type" :rules="[
      						{ required: true, message: '字典类型不能为空'},
      						{ max: 20, message: '字典类型不超过20个字符'}
    					]">
					<el-input v-model="form.type" placeholder="请输入字典类型,不大于20个字符"></el-input>
				</el-form-item>
				<el-form-item label="用途描述" prop="describe" :rules="[
      						{ required: true, message: '数据描述不能为空'},
      						{ max: 20, message: '数据描述不超过20个字符'}
    					]">
					<el-input v-model="form.describe" placeholder="请输入数据描述,不大于20个字符"></el-input>
				</el-form-item>
				<el-form-item label="编码" prop="code" :rules="[
      						{ required: true, message: '编码不能为空'},
      						{ type: 'number', message: '输入数字'}
    					]">

					<el-input v-model.number="form.code" type="number" placeholder="请输入编码,0-9"></el-input>
				</el-form-item>
				<el-form-item label="编码值" prop="cvalue" :rules="[
      						{ required: true, message: '编码值不能为空'},
      						{ max: 10, message: '编码值不超过10个字符'}
    					]">
					<el-input v-model="form.cvalue" placeholder="请输入编码值,不大于10个字符"></el-input>
				</el-form-item>
				<el-form-item>
					<el-button @click="dialogVisible = false">取 消</el-button>
					<el-button type="primary" @click="onSubmit">确 定</el-button>
				</el-form-item>
				</el-from>
		</el-dialog>
	</div>

</div>
<!-- import Vue before Element -->
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<!-- import JavaScript -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script>
	new Vue({
		el: '#app',
		data: function() {
			return {
				tableData: [],
				dialogVisible: false,
				isEdit: false,
				selectedRow: 0,
				form: {
					type: '',
					describe: '',
					code: 0,
					cvalue: ''
				},
				//更新数据需要旧和新的数据,因为type不是唯一的
				dataForUpdate: [],
				//需要删除的记录
				dataForDel: [],
				dataNotUpdate: {
					type: '',
					describe: '',
					code: 0,
					cvalue: ''
				}
			}
		},
		//初始化数据流
		created() {
			this.init()
		},
		methods: {
			init(){
				this.tableData = []
				$.ajax({
					type: 'POST',
					dataType: "json",
					url: "http://localhost:8090/springmybatis//initDictionary",
					success: function(res) {
						$.each(res, function(i, obj) {
							this.tableData.push({
								type: obj.dicType,
								describe: obj.dicDiscribe,
								code: obj.dicCode,
								cvalue: obj.dicValue
							}) //循环遍历，拼接
						}.bind(this));
						console.log(this.tableData)
					}.bind(this),
					error: function() {
						alert("初始化数据失败");
					}
				});
			},
			//选中checkbox后的对象数组传给即将删除的
			handleSelectionChange(val) {
				if(val.length != 0) {
					this.dataForDel = val;
					console.log(this.dataForDel)
				}

			},
			handleEdit(row, isEdit) {
				//修改
				if(isEdit) {
					this.form.type = this.tableData[row].type;
					this.form.describe = this.tableData[row].describe;
					this.form.code = this.tableData[row].code;
					this.form.cvalue = this.tableData[row].cvalue;
					this.dataNotUpdate.type = this.tableData[row].type;
					this.dataNotUpdate.describe = this.tableData[row].describe;
					this.dataNotUpdate.code = this.tableData[row].code;
					this.dataNotUpdate.cvalue = this.tableData[row].cvalue;
					this.isEdit = isEdit;
					this.selectedRow = row;
					this.dataForUpdate.push(this.dataNotUpdate)
				}
				//新增
				else {
					this.form.type = '';
					this.form.describe = '';
					this.form.code = '';
					this.form.cvalue = '';
					this.isEdit = isEdit;
				}
				this.dialogVisible = true;
			},
			//新增或者修改的提交
			onSubmit() {
				//更新提交
				if(this.isEdit) {
					var dtype = this.form.type
					var ddescribe = this.form.describe
					var dcode = this.form.code
					var dcvalue = this.form.cvalue
					var updatedData = {
						type: dtype,
						describe: ddescribe,
						code: dcode,
						cvalue: dcvalue
					}
					this.dataForUpdate.push(this.form)
					$.ajax({
						type: "POST",
						url: "http://localhost:8090/springmybatis//updateDictionary",
						contentType: "application/json; charset=utf-8",
						data: JSON.stringify(this.dataForUpdate),
						dataType: "json",
						success: function(data) {
							//成功信息
							console.log("success")
							if(data.result == "SUCCESS") {
								this.$set(this.tableData,this.selectedRow,updatedData)
//										this.tableData[this.selectedRow] = updatedData
								alert("修改成功!")
							} else {
								alert("修改失败")
							}
						}.bind(this),
						error: function(message) {
							//失败信息
							console.log("error")
						}
					});
				}
				//新增提交
				else {
					var dtype = this.form.type
					var ddescribe = this.form.describe
					var dcode = this.form.code
					var dcvalue = this.form.cvalue
					$.ajax({
						type: "POST",
						url: "http://localhost:8090/springmybatis//insertDictionary",
						contentType: "application/json; charset=utf-8",
						data: JSON.stringify(this.form),
						dataType: "json",
						success: function(data) {
							//成功信息
							console.log("success")
							if(data.result == "SUCCESS") {
								this.tableData.push({
									type: dtype,
									describe: ddescribe,
									code: dcode,
									cvalue: dcvalue
								})
								alert("插入成功!")
							} else {
								alert("插入失败")
							}
						}.bind(this),
						error: function(message) {
							//失败信息
							console.log("error")
						}
					});
				}
				//手动刷新
				//window.location.reload()
				this.dialogVisible = false;
			},
			handleDel() {
				$.ajax({
					type: "POST",
					url: "http://localhost:8090/springmybatis//deleteDictionary",
					contentType: "application/json; charset=utf-8",
					data: JSON.stringify(this.dataForDel),
					dataType: "json",
					success: function(data) {
						//成功信息
						console.log("success")
						if(data.result == "SUCCESS") {
							this.init()
							alert("删除成功!")
						} else {
							alert("删除失败")
						}
					}.bind(this),
					error: function(message) {
						//失败信息
						console.log("error")
					}
				});
			}
		},
		watch: {
			tableData(newVal) {
				console.log(newVal)
			}
		}
	})
</script>
</body>

</html>